use e-kaly

db.roles.insertMany([
	{"libelle": "super-utilisateur", "valeur": 10},
	{"libelle": "utilisateur", "valeur": 1},
	{"libelle": "livreur", "valeur": 3},
	{"libelle": "resto", "valeur": 2}
	]);
	
db.villes.insertMany([
	{"libelle": "Analakely"},
	{"libelle": "Ivato"}
	]);	
		

db.users.insert(
	{"nom": "Rakoto",
	"prenom":"Jean",
	"email": "rakoto@mail.com",
	"contact": "0342050010",
	"adresse": "Andoharanofotsy",
	"ville": ObjectId("62486e5eb51e6994ffaea350"),
	"mdp": "123456",
	"sexe": "homme",
	"role": ObjectId("62486e4eb51e6994ffaea34b")
	}
	);
	
db.users.aggregate([
	{
		$lookup:{
			from: "villes",
			localField: "ville",
			foreignField: "_id",
			as: "ville"
		}	
	},
	{
		$lookup:{
			from: "roles",
			localField: "role",
			foreignField: "_id",
			as: "role"
		}
	}
]).pretty();

db.users.update({"_id" : ObjectId("62474b2567624f4e9b6c9948")}, {$set: {mdp: "e10adc3949ba59abbe56e057f20f883e"}});

db.users.findOne({"sexe": "homme"}).select({"name": 1})

db.users.update({"_id" : ObjectId("62474b2567624f4e9b6c9948")}, {$set: {ville: ObjectId("62486e5eb51e6994ffaea350")}});
db.users.update({"_id" : ObjectId("62474b2567624f4e9b6c9948")}, {$set: {role: ObjectId("62486e4eb51e6994ffaea34b")}});


db.roles.find().sort({valeur: 1})

db.users.remove({nom: null})


db.users.aggregate([
	{
		$match:{_id: ObjectId("62487ff0ce4044dfca07507c")}
	},	
	{
		$lookup:{
			from: "villes",
			localField: "ville",
			foreignField: "_id",
			as: "ville"
		}	
	},
	{
		$lookup:{
			from: "roles",
			localField: "role",
			foreignField: "_id",
			as: "role"
		}
	}
]).pretty();

db.users.aggregate([
	{
		$match:{nom: "Rajaona"}
	}
])

	db.users.aggregate([
		{
			$match:{nom: { $regex: "zafy", $options: "i" } }
		}
	]).pretty();

db.sessions.find().pretty();

	db.sessions.aggregate([
		{
			$lookup:{
				from: "users",
				localField: "user",
				foreignField: "_id",
				as: "u"
			}	
		},
		{
			$lookup:{
				from: "roles",
				localField: "u.role",
				foreignField: "_id",
				as: "role"
			}
		}
	]).pretty();

	db.restos.insert(
	{"nom": "Pho",
	"contact": "0342050010",
	"adresse": "Andoharanofotsy",
	"ville": ObjectId("62486e5eb51e6994ffaea350"),
	"users":[
		{
			"user": ObjectId("62474b2567624f4e9b6c9948"),
			"etat": 0
		}
	] 
	}
	);
	
	
	db.restos.aggregate([
		{
			$lookup: {
				from: "villes",
				localField: "ville",
				foreignField: "_id",
				as: "ville"
			}			
		}
	]).pretty();

	db.restos.aggregate([		
		{
			$lookup:{
				from: "villes",
				localField: "ville",
				foreignField: "_id",
				as: "ville"
			}	
		},
		{
			$lookup:{
				from: "users",
				localField: "users.user",
				foreignField: "_id",
				as: "users"
			}	
		}
	]).pretty();	


	db.users.aggregate([
		{
			$lookup:{
				from: "roles",
				localField: "role",
				foreignField: "_id",
				as: "role"
			}	
		},
		{

			$filter:{
				role:{$eq: 10}
			}
		}
	]
	).pretty();
	,
		{

		},
		{
			$project:{
				role: {
					$filter:{
						input: "$role",
						as: "role",
						cond: {$eq: ["$$role.valeur", 10]}
					}
				}
			}
		}